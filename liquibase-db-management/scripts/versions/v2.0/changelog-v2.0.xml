<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <!-- Version 2.0: Order Management -->
    <changeSet id="2.0-001" author="db-admin">
        <comment>Create orders table for order management</comment>
        
        <createTable tableName="orders">
            <column name="id" type="SERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="order_number" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="pending">
                <constraints nullable="false"/>
            </column>
            <column name="total_amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="shipping_address" type="TEXT"/>
            <column name="billing_address" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <rollback>
            <dropTable tableName="orders"/>
        </rollback>
    </changeSet>

    <changeSet id="2.0-002" author="db-admin">
        <comment>Create order_items table for order line items</comment>
        
        <createTable tableName="order_items">
            <column name="id" type="SERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="product_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="unit_price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="total_price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <rollback>
            <dropTable tableName="order_items"/>
        </rollback>
    </changeSet>

    <changeSet id="2.0-003" author="db-admin">
        <comment>Add foreign key constraints</comment>
        
        <addForeignKeyConstraint baseTableName="orders" baseColumnNames="user_id"
                                 constraintName="fk_orders_user_id"
                                 referencedTableName="users" referencedColumnNames="id"
                                 onDelete="CASCADE"/>
        
        <addForeignKeyConstraint baseTableName="order_items" baseColumnNames="order_id"
                                 constraintName="fk_order_items_order_id"
                                 referencedTableName="orders" referencedColumnNames="id"
                                 onDelete="CASCADE"/>
        
        <addForeignKeyConstraint baseTableName="order_items" baseColumnNames="product_id"
                                 constraintName="fk_order_items_product_id"
                                 referencedTableName="products" referencedColumnNames="id"
                                 onDelete="CASCADE"/>
        
        <rollback>
            <dropForeignKeyConstraint baseTableName="orders" constraintName="fk_orders_user_id"/>
            <dropForeignKeyConstraint baseTableName="order_items" constraintName="fk_order_items_order_id"/>
            <dropForeignKeyConstraint baseTableName="order_items" constraintName="fk_order_items_product_id"/>
        </rollback>
    </changeSet>

    <changeSet id="2.0-004" author="db-admin">
        <comment>Add check constraints for orders and order_items</comment>
        
        <addCheckConstraint tableName="orders" constraintName="chk_orders_status" 
                           checkCondition="status IN ('pending', 'confirmed', 'shipped', 'delivered', 'cancelled')"/>
        
        <addCheckConstraint tableName="orders" constraintName="chk_orders_total_amount" 
                           checkCondition="total_amount >= 0"/>
        
        <addCheckConstraint tableName="order_items" constraintName="chk_order_items_quantity" 
                           checkCondition="quantity > 0"/>
        
        <addCheckConstraint tableName="order_items" constraintName="chk_order_items_unit_price" 
                           checkCondition="unit_price >= 0"/>
        
        <addCheckConstraint tableName="order_items" constraintName="chk_order_items_total_price" 
                           checkCondition="total_price >= 0"/>
        
        <rollback>
            <dropCheckConstraint tableName="orders" constraintName="chk_orders_status"/>
            <dropCheckConstraint tableName="orders" constraintName="chk_orders_total_amount"/>
            <dropCheckConstraint tableName="order_items" constraintName="chk_order_items_quantity"/>
            <dropCheckConstraint tableName="order_items" constraintName="chk_order_items_unit_price"/>
            <dropCheckConstraint tableName="order_items" constraintName="chk_order_items_total_price"/>
        </rollback>
    </changeSet>

    <changeSet id="2.0-005" author="db-admin">
        <comment>Create indexes for orders and order_items tables</comment>
        
        <createIndex tableName="orders" indexName="idx_orders_user_id">
            <column name="user_id"/>
        </createIndex>
        
        <createIndex tableName="orders" indexName="idx_orders_status">
            <column name="status"/>
        </createIndex>
        
        <createIndex tableName="orders" indexName="idx_orders_created_at">
            <column name="created_at"/>
        </createIndex>
        
        <createIndex tableName="order_items" indexName="idx_order_items_order_id">
            <column name="order_id"/>
        </createIndex>
        
        <createIndex tableName="order_items" indexName="idx_order_items_product_id">
            <column name="product_id"/>
        </createIndex>
        
        <rollback>
            <dropIndex tableName="orders" indexName="idx_orders_user_id"/>
            <dropIndex tableName="orders" indexName="idx_orders_status"/>
            <dropIndex tableName="orders" indexName="idx_orders_created_at"/>
            <dropIndex tableName="order_items" indexName="idx_order_items_order_id"/>
            <dropIndex tableName="order_items" indexName="idx_order_items_product_id"/>
        </rollback>
    </changeSet>

    <changeSet id="2.0-006" author="db-admin">
        <comment>Add comments to orders and order_items tables</comment>
        
        <sql>COMMENT ON TABLE orders IS 'Customer orders table';</sql>
        <sql>COMMENT ON TABLE order_items IS 'Order line items table';</sql>
        <sql>COMMENT ON COLUMN orders.order_number IS 'Unique order identifier';</sql>
        <sql>COMMENT ON COLUMN orders.status IS 'Order status';</sql>
        <sql>COMMENT ON COLUMN orders.total_amount IS 'Total order amount';</sql>
        
        <rollback>
            <sql>COMMENT ON TABLE orders IS NULL;</sql>
            <sql>COMMENT ON TABLE order_items IS NULL;</sql>
            <sql>COMMENT ON COLUMN orders.order_number IS NULL;</sql>
            <sql>COMMENT ON COLUMN orders.status IS NULL;</sql>
            <sql>COMMENT ON COLUMN orders.total_amount IS NULL;</sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
